<html>
<head>
<link rel="shortcut icon" href="#" />
<link rel="stylesheet" href="style.css">
<script src="https://rawgit.com/moment/moment/2.2.1/min/moment.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript">
var restUrl = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');

function getTxElement(tx)
{
    let d = document;
    let tr = d.createElement('tr');
    tr.appendChild(d.createElement('td')).innerHTML = tx.id;
    // tr.lastElementChild.setAttribute('class', 'minercol');

    var txInHtml = '';
    // if (tx.inputs.length == 1 && tx.inputs[0].txOutIndex == 0)
    // {
    //     // this is the coinbase transaction
    //     var amount = tx.outputs[0].amount;
    //     txInHtml += "Coinbase: " + amount;
    // }
    for (idx = 0; idx < tx.inputs.length; idx++)
    {
        var sourceAddress = tx.inputs[idx].txOutId;
        // assume this is the generation tx
        if (sourceAddress.length == 0) 
        {
            txInHtml += "<i>Mining Reward</i>: " + tx.outputs[0].amount + "<br/>";
            break;
        }
        else
        {
            txInHtml += "(" + tx.inputs[0].txOutIndex + ":" + sourceAddress + ")<br/>";
        }
    }
    tr.appendChild(d.createElement('td')).innerHTML = txInHtml;
    // tr.lastElementChild.setAttribute('class', 'minercol');

    var totalamount = 0.0;
    var outputHtml = '';
    for (x = 0; x < tx.outputs.length; x++)
    {
        var amount = tx.outputs[x].amount;
        var address = tx.outputs[x].address;

        totalamount += tx.outputs[x].amount;
        outputHtml += `<a href='${restUrl}/address/${address}'>${address}</a>: ${amount}<br/>`;
    }

    tr.appendChild(d.createElement('td')).innerHTML = outputHtml;
    tr.appendChild(d.createElement('td')).innerHTML = totalamount;
    return tr;
}

function onLoad()
{
    var blockJsonPath = restUrl + location.pathname + "/json";
    $.ajax(
    {
        url: blockJsonPath,
        type: 'GET', 
        success: function(datastr) 
        {
            console.log("get json(" + blockJsonPath + ")");
            var el = document.getElementById("txlist");
            var block = JSON.parse(datastr);

            var dt = moment.unix(block.time/1000).utc();
            $('#blocktime').text(dt.format("YYYY-MM-DD HH:mm:ss"));

            

            for (i = 0; i < block.transactions.length; i++)
            {
                var tx = block.transactions[i];
                var newel = getTxElement(tx);
                el.appendChild(newel);
            }
        },
        error: function()
        {
            setTimeout(onLoadBlocks, 5000);
        }
    });
}
</script>
<style>
.info-table tr th
{
    border: none;
}
.info-table tr th:nth-child(2)
{
    font-size: 16px;
    font-weight: normal;
    text-align: right;
}
.tx-table tr th
{
    border: 1px solid black;
    background-color:lightblue;
    text-align: left;
    font-weight: bold;
    padding: 5px;
}
</style>
</head>
<body onload="javascript:onLoad();">

<!-- HEADER -->
<h2>%app-title% (%app-domain%)</h2>
<!-- /HEADER -->

<table class="info-table">
    <tr>
        <th>Block #%block-id%</th>
        <th><a href="/block/%block-previd%">prev</a>&nbsp;<a href="/block/%block-nextid%">next</a></th>
    </tr>

    <tr><td>Hash</td><td>%block-hash%</td></tr>
    <tr><td>Previous Hash</td><td>%block-previoushash%</td></tr>
    <tr><td>Height</td><td>%block-id%</td></tr>
    <tr><td>Time</td><td id="blocktime"></td></tr>
    <tr><td>Difficulty</td><td>%block-difficulty%</td></tr>
    <tr><td>Nonce</td><td>%block-nonce%</td></tr>
    <tr><td>Transactions</td><td>%block-transactions%</td></tr>
</table>

<br/>

<h3>Transactions</h3>
<table class="tx-table">
    <tr>
        <th>Transaction ID</th>
        <th>From (amount)</th>
        <th>To (amount)</th>
        <th>Amount</th>
    </tr>

    <tbody id="txlist">
    </tbody>
</table>

<!-- FOOTER -->
<br/>
<small>%app-copyright% (<a href="%app-github%" target="_blank">%app-github%</a>)</small>
<!-- /FOOTER -->
</body>
</html>